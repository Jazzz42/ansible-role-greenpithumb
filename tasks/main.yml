---
- name: load variables
  include_vars: "main.yml"

- name: create greenpithumb group
  group:
    name: "{{ greenpithumb_group }}"
    state: "present"

- name: create greenpithumb user
  user:
    name: "{{ greenpithumb_user }}"
    group: "{{ greenpithumb_group }}"
    system: "yes"

- name: install necessary packages
  apt:
    name: "{{ item }}"
    state: installed
  with_items:
    - build-essential
    - git
    - python-dev
    - python-openssl
    - python-pip

- name: install libraries
  pip:
    name: "{{ item }}"
  with_items:
    - adafruit-mcp3008
    - RPi.GPIO

- name: download Adafruit DHT library
  git:
    repo: https://github.com/adafruit/Adafruit_Python_DHT
    version: master
    dest: "{{ __greenpithumb_adafruit_dht_tmp_path }}"
  notify:
    - install Adafruit DHT library

- name: set Adafruit DHT library test compatibility
  set_fact:
    adafruit_dht_extra_args: "--force-test"
  when: "'arm' not in ansible_machine"

- name: download greenpithumb backend code
  git:
    repo: https://github.com/JeetShetty/GreenPiThumb
    dest: "{{ greenpithumb_backend_path }}"
    version: "{{ greenpithumb_git_version }}"

- name: set greenpithumb file permissions
  file:
    path: "{{ greenpithumb_backend_path }}"
    owner: "{{ greenpithumb_user }}"
    group: "{{ greenpithumb_group }}"
    recurse: yes
    state: directory
